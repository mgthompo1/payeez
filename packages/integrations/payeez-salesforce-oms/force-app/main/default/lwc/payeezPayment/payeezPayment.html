<template>
    <lightning-card title="Payment" icon-name="utility:money">
        <div class="slds-p-around_medium">

            <!-- Test Mode Badge -->
            <template if:true={isTestMode}>
                <div class="slds-m-bottom_small">
                    <lightning-badge label="Test Mode" class="slds-theme_warning"></lightning-badge>
                </div>
            </template>

            <!-- Loading State -->
            <template if:true={isLoading}>
                <lightning-spinner alternative-text="Loading..." size="medium"></lightning-spinner>
            </template>

            <!-- Error Message -->
            <template if:true={errorMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_error slds-m-bottom_small" role="alert">
                    <span class="slds-assistive-text">Error</span>
                    <h2>{errorMessage}</h2>
                </div>
            </template>

            <!-- Success Message -->
            <template if:true={successMessage}>
                <div class="slds-notify slds-notify_alert slds-alert_success slds-m-bottom_small" role="alert">
                    <span class="slds-assistive-text">Success</span>
                    <h2>{successMessage}</h2>
                </div>
            </template>

            <!-- Payment Form -->
            <template if:false={isLoading}>
                <template if:false={paymentComplete}>

                    <!-- Order Details -->
                    <div class="slds-m-bottom_medium">
                        <dl class="slds-dl_horizontal">
                            <dt class="slds-dl_horizontal__label">Order:</dt>
                            <dd class="slds-dl_horizontal__detail">{orderNumber}</dd>
                            <dt class="slds-dl_horizontal__label">Amount:</dt>
                            <dd class="slds-dl_horizontal__detail">{formattedAmount}</dd>
                        </dl>
                    </div>

                    <!-- Saved Cards -->
                    <template if:true={hasSavedCards}>
                        <div class="slds-m-bottom_medium">
                            <lightning-radio-group
                                name="savedCard"
                                label="Select Payment Method"
                                options={savedCardOptions}
                                value={selectedCard}
                                onchange={handleCardSelection}
                            ></lightning-radio-group>
                        </div>
                    </template>

                    <!-- Card Element Container -->
                    <template if:true={showCardForm}>
                        <div class="slds-m-bottom_medium">
                            <label class="slds-form-element__label">Card Details</label>
                            <div
                                class="payeez-card-element slds-box"
                                lwc:dom="manual"
                                data-id="card-element"
                            ></div>
                            <div class="slds-text-color_error slds-text-body_small slds-m-top_xx-small">
                                {cardError}
                            </div>
                        </div>

                        <!-- Save Card Checkbox -->
                        <template if:true={isLoggedIn}>
                            <lightning-input
                                type="checkbox"
                                label="Save card for future purchases"
                                name="saveCard"
                                checked={saveCard}
                                onchange={handleSaveCardChange}
                            ></lightning-input>
                        </template>
                    </template>

                    <!-- Submit Button -->
                    <div class="slds-m-top_medium">
                        <lightning-button
                            variant="brand"
                            label="Pay Now"
                            onclick={handlePayment}
                            disabled={isProcessing}
                        ></lightning-button>
                    </div>

                </template>

                <!-- Payment Complete -->
                <template if:true={paymentComplete}>
                    <div class="slds-text-align_center slds-p-around_large">
                        <lightning-icon
                            icon-name="utility:success"
                            alternative-text="Success"
                            size="large"
                            class="slds-m-bottom_small"
                        ></lightning-icon>
                        <h2 class="slds-text-heading_medium">Payment Successful</h2>
                        <p class="slds-text-body_regular slds-m-top_small">
                            Transaction ID: {transactionId}
                        </p>
                    </div>
                </template>
            </template>

        </div>
    </lightning-card>
</template>
